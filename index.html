<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Auraa Billing PRO - V1 Ultimate</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* ==========================================================================
           1. CORE VARIABLES & THEME CONFIGURATION
           ========================================================================== */
        :root {
            /* Brand Colors */
            --primary: #2563eb;       /* Royal Blue */
            --primary-dark: #1e40af;  /* Dark Blue */
            --secondary: #64748b;     /* Slate Gray */
            --success: #16a34a;       /* Green */
            --danger: #dc2626;        /* Red */
            --warning: #ca8a04;       /* Gold/Yellow */
            --whatsapp: #25D366;      /* WhatsApp Green */
            --insta: #E1306C;         /* Instagram Pink */
            
            /* Backgrounds */
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --border-color: #e2e8f0;
            
            /* Layout */
            --radius: 10px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* ==========================================================================
           2. GLOBAL RESETS & BASE STYLES
           ========================================================================== */
        * {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: #0f172a;
            font-size: 14px;
            padding-bottom: 100px; /* Space for Bottom Nav */
            user-select: none; /* App-like feel */
        }

        /* ==========================================================================
           3. LAYOUT UTILITIES
           ========================================================================== */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 15px;
        }

        .hidden {
            display: none !important;
        }

        .flex-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .space-between {
            justify-content: space-between;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .w-full { width: 100%; }
        .bold { font-weight: 700; }

        /* ==========================================================================
           4. COMPONENT STYLES (Cards, Buttons, Inputs)
           ========================================================================== */
        /* Cards */
        .card {
            background: var(--bg-card);
            padding: 16px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            margin-bottom: 16px;
        }

        /* Stats Box */
        .stat-box {
            background: var(--bg-card);
            padding: 12px 5px;
            border-radius: var(--radius);
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .stat-box h3 { margin: 0; font-size: 15px; color: var(--primary); }
        .stat-box p { margin: 4px 0 0; font-size: 10px; color: var(--secondary); text-transform: uppercase; font-weight: 800; }

        /* Inputs */
        label {
            display: block;
            font-size: 11px;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        input, select {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 15px;
            background: #fff;
            transition: all 0.2s;
        }

        input:focus, select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        input[readonly] {
            background-color: #f1f5f9;
            color: #94a3b8;
            pointer-events: none;
        }

        /* Buttons */
        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            color: white;
            text-align: center;
            transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.8; transform: scale(0.98); }
        
        .btn-primary { background-color: var(--primary); }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-warning { background-color: var(--warning); color: white; }
        .btn-whatsapp { background-color: var(--whatsapp); color: white; }
        .btn-outline { 
            background-color: transparent; 
            border: 1px solid var(--primary); 
            color: var(--primary); 
        }
        .btn-sm { padding: 6px 12px; font-size: 12px; width: auto; display: inline-block; }
        .btn-disabled { background-color: #cbd5e1 !important; cursor: not-allowed; }

        /* ==========================================================================
           5. STAFF MODE & NAVIGATION
           ========================================================================== */
        /* Logic: Hide owner elements when body has .staff-mode class */
        body.staff-mode .owner-only { display: none !important; }
        body.staff-mode .nav-bar { border-top: 3px solid var(--warning); }

        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 1000;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.05);
        }

        .nav-item {
            flex: 1;
            text-align: center;
            font-size: 10px;
            color: var(--secondary);
            background: none;
            border: none;
            cursor: pointer;
        }

        .nav-item span {
            display: block;
            font-size: 20px;
            margin-bottom: 3px;
        }

        .nav-item.active {
            color: var(--primary);
            font-weight: bold;
        }

        /* List Items */
        .list-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .list-item:last-child { border-bottom: none; }

        /* ==========================================================================
           6. PRINTING & IMAGE GENERATION STYLES
           ========================================================================== */
        
        /* Hidden Area for HTML2Canvas to render the receipt image */
        #receipt-render-area {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 380px; /* Standard width for good resolution */
            background: white;
            padding: 20px;
            color: black;
            font-family: monospace;
            border: 1px solid #000;
        }
        .r-header { text-align: center; border-bottom: 1px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }
        .r-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .r-table th { text-align: left; border-bottom: 1px dashed #000; padding: 4px; }
        .r-table td { padding: 4px; }
        .r-total { border-top: 1px dashed #000; margin-top: 10px; padding-top: 10px; text-align: right; font-weight: bold; font-size: 14px; }

        /* Print CSS */
        #print-area { display: none; }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white;
                color: black;
                z-index: 9999;
                padding: 0; margin: 0;
            }
            .no-print { display: none !important; }

            /* A4 Styles */
            .print-a4 { padding: 40px; font-family: 'Times New Roman', serif; max-width: 800px; margin: 0 auto; }
            .print-a4 .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 20px; }
            .print-a4 img { max-height: 80px; display: block; margin: 0 auto 10px auto; }
            .print-a4 h1 { margin: 5px 0; font-size: 28px; text-transform: uppercase; }
            .print-a4 .meta { display: flex; justify-content: space-between; border-bottom: 1px dotted #000; padding-bottom: 10px; margin-bottom: 20px; }
            .print-a4 table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
            .print-a4 th { border: 1px solid #000; padding: 8px; background: #eee !important; -webkit-print-color-adjust: exact; text-align: left; }
            .print-a4 td { border: 1px solid #000; padding: 8px; }
            .print-a4 .text-r { text-align: right; }
            .print-a4 .totals { text-align: right; margin-top: 20px; }
            
            /* Thermal Styles */
            .print-thermal { padding: 5px; font-family: monospace; width: 100%; max-width: 300px; margin: 0 auto; font-size: 12px; }
            .print-thermal .header { text-align: center; border-bottom: 1px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }
            .print-thermal img { max-height: 50px; filter: grayscale(100%); margin: 0 auto; display: block; }
            .print-thermal table { width: 100%; font-size: 11px; }
            .print-thermal th { text-align: left; border-bottom: 1px dashed #000; }
            .print-thermal td { padding: 4px 0; }
            .print-thermal .text-r { text-align: right; }
            .print-thermal .totals { border-top: 1px dashed #000; margin-top: 10px; padding-top: 5px; text-align: right; }
        }
    </style>
</head>
<body>

    <div id="auth-view" class="container">
        <center style="margin-top: 60px; margin-bottom: 40px;">
            <h1 style="color:var(--primary); font-size: 36px; margin-bottom: 5px;">AURAA PRO</h1>
            <p style="color:var(--secondary); font-size: 16px;">V19 Ultimate Business System</p>
        </center>
        
        <div id="login-box" class="card">
            <h3 class="text-center" style="margin-top:0;">Shop Owner Login</h3>
            <label>Registered Mobile Number</label>
            <input type="number" id="l-mob" placeholder="Enter 10 Digit Mobile">
            <label>Password</label>
            <input type="password" id="l-pass" placeholder="Enter Password">
            <button class="btn btn-primary" onclick="app.login()">Secure Login</button>
            
            <div class="text-center" style="margin-top: 20px;">
                <p>New Here? <a onclick="ui.toggleAuth('reg')" style="color:var(--primary); cursor: pointer; font-weight:bold;">Register Shop</a></p>
                
                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 15px; border: 1px dashed #ccc;">
                    <p style="margin: 0 0 5px 0; font-weight: bold; font-size: 12px;">Forgot Password?</p>
                    <p style="margin: 0 0 10px 0; font-size: 11px; color: #666;">Contact Developer to Reset:</p>
                    <div class="flex-row space-between">
                        <button class="btn-sm btn-whatsapp" style="width: 48%;" onclick="window.open('https://wa.me/918000595588?text=Hello%20Priyansh%20Sir,%20I%20forgot%20my%20Auraa%20Billing%20Password', '_blank')">
                            WhatsApp
                        </button>
                        <button class="btn-sm" style="width: 48%; background: var(--insta); color: white;" onclick="window.open('https://instagram.com/mr_priyansh_10k', '_blank')">
                            Instagram
                        </button>
                    </div>
                </div>
            </div>
            
            <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border-color);">
            <button class="btn btn-sm btn-outline" style="width:100%" onclick="ui.toggleAuth('admin')">Admin Master Panel</button>
        </div>

        <div id="reg-box" class="card hidden">
            <h3 class="text-center" style="margin-top:0;">Register New Shop</h3>
            <label>Shop Name</label>
            <input type="text" id="r-name" placeholder="E.g. Auraa Fashion">
            <label>Shop Address</label>
            <input type="text" id="r-addr" placeholder="City, Area">
            <label>Mobile Number (Login ID)</label>
            <input type="number" id="r-mob" placeholder="10 Digit Mobile Number">
            <label>Create Password</label>
            <input type="password" id="r-pass" placeholder="Create Secret Password">
            <label>Owner PIN (For Staff Unlock)</label>
            <input type="number" id="r-pin" placeholder="4 Digit PIN">
            <button class="btn btn-success" onclick="app.register()">Create Account</button>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="ui.toggleAuth('login')">Back to Login</button>
        </div>

        <div id="admin-box" class="card hidden">
            <h3 class="text-center text-danger" style="margin-top:0;">Admin Access</h3>
            <label>Master Password</label>
            <input type="password" id="a-pass" placeholder="Enter Admin Key">
            <button class="btn btn-danger" onclick="admin.login()">Access Panel</button>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="ui.toggleAuth('login')">Back</button>
        </div>
    </div>

    <div id="app-view" class="container hidden">
        <div class="flex-row space-between" style="padding: 10px 0; border-bottom: 1px solid var(--border-color); margin-bottom: 15px;">
            <div>
                <h2 id="shop-title" style="margin:0; font-size: 18px;">Shop Name</h2>
                <small id="sub-status" style="color:var(--success); font-weight:bold;">‚óè Active Plan</small>
            </div>
            <div class="flex-row">
                <button id="lock-btn" class="btn-sm btn-warning" onclick="app.toggleStaff()">üîí Staff</button>
                <button class="btn-sm btn-danger" onclick="app.logout()">Logout</button>
            </div>
        </div>

        <div id="tab-dash">
            <div class="grid-4">
                <div class="stat-box">
                    <h3 id="d-sale">‚Çπ0</h3><p>Today Sale</p>
                </div>
                <div class="stat-box">
                    <h3 id="d-udhaar" style="color:var(--warning)">‚Çπ0</h3><p>Total Udhaar</p>
                </div>
                <div class="stat-box owner-only">
                    <h3 id="d-exp" style="color:var(--danger)">‚Çπ0</h3><p>Expenses</p>
                </div>
                <div class="stat-box owner-only">
                    <h3 id="d-profit" style="color:var(--success)">‚Çπ0</h3><p>Net Profit</p>
                </div>
            </div>

            <div class="card owner-only">
                <h4 style="margin-top:0">‚ö†Ô∏è Low Stock Alert</h4>
                <div id="low-stock-list" style="font-size:12px; color:var(--secondary); max-height: 100px; overflow-y: auto;">
                    Scanning Inventory...
                </div>
            </div>

            <button id="btn-new-inv" class="btn btn-primary" onclick="ui.tab('bill')">+ Create New Invoice</button>
        </div>

        <div id="tab-bill" class="hidden">
            <div class="card">
                <h4>Customer Details</h4>
                <div class="grid-2">
                    <div>
                        <label>Mobile (Auto-Fill)*</label>
                        <input type="number" id="b-cmob" placeholder="Search Mobile..." oninput="billing.checkCustomer(this)">
                    </div>
                    <div>
                        <label>Customer Name*</label>
                        <input type="text" id="b-cname" placeholder="Name">
                    </div>
                </div>
                <label>Address</label>
                <input type="text" id="b-caddr" placeholder="City / Area">
            </div>

            <div class="card">
                <div class="flex-row space-between" style="margin-bottom:10px;">
                    <h4 style="margin:0">Items Cart</h4>
                    <button class="btn-sm btn-outline" onclick="billing.addRow()">+ Add Item</button>
                </div>
                <div id="bill-rows-container">
                    </div>
            </div>

            <div class="card">
                <div class="grid-2">
                    <div>
                        <label>Discount Type</label>
                        <select id="b-disc-type" onchange="billing.calc()">
                            <option value="flat">Flat ‚Çπ</option>
                            <option value="percent">Percent %</option>
                        </select>
                    </div>
                    <div>
                        <label>Discount Value</label>
                        <input type="number" id="b-disc-val" value="0" oninput="billing.calc()">
                    </div>
                </div>
                <div class="grid-2">
                    <div>
                        <label>Tax / GST (%)</label>
                        <input type="number" id="b-tax" value="0" oninput="billing.calc()">
                    </div>
                    <div>
                        <label>Amount Paid</label>
                        <input type="number" id="b-paid" placeholder="Cash Received" oninput="billing.calc()">
                    </div>
                </div>
                <hr style="margin:15px 0; border:0; border-top:1px dashed #ccc;">
                <div class="flex-row space-between">
                    <span>Grand Total:</span>
                    <strong id="b-total" style="font-size:20px; color:var(--primary)">‚Çπ0</strong>
                </div>
                <div class="flex-row space-between" style="color:var(--danger); margin-top:5px;">
                    <span>Balance Due (Udhaar):</span>
                    <strong id="b-due">‚Çπ0</strong>
                </div>
                
                <div class="grid-2" style="margin-top:20px;">
                    <button id="btn-save-bill" class="btn btn-success" onclick="billing.save()">SAVE & PRINT</button>
                    <button id="btn-wa-share" class="btn btn-whatsapp hidden" onclick="billing.genImage()">WHATSAPP BILL</button>
                </div>
            </div>
        </div>

        <div id="tab-stock" class="hidden owner-only">
            <div class="card">
                <h4 style="margin-top:0">Add New Product</h4>
                <label>Item Name</label>
                <input type="text" id="s-name" placeholder="Product Name">
                <div class="grid-2">
                    <div><label>MRP</label><input type="number" id="s-mrp" placeholder="0"></div>
                    <div><label>Selling Price</label><input type="number" id="s-sp" placeholder="0"></div>
                </div>
                <div class="grid-2">
                    <div><label>Cost Price (Buy Rate)</label><input type="number" id="s-cp" placeholder="0"></div>
                    <div><label>Quantity</label><input type="number" id="s-qty" placeholder="0"></div>
                </div>
                <button class="btn btn-primary" onclick="stock.add()">Save to Stock</button>
            </div>
            
            <div class="card">
                <input type="text" id="s-search" placeholder="Search Inventory..." oninput="stock.render()">
                <div id="stock-list" style="margin-top:10px"></div>
            </div>
        </div>

        <div id="tab-history" class="hidden owner-only">
            <div class="card">
                <input type="text" id="h-search" placeholder="Search by Customer Name..." oninput="history.render()">
                <div id="history-list" style="margin-top:10px"></div>
            </div>
        </div>

        <div id="tab-expense" class="hidden owner-only">
            <div class="card">
                <h4 style="margin-top:0">Record Daily Expense</h4>
                <div class="grid-2">
                    <div><label>Description</label><input type="text" id="e-desc" placeholder="Tea, Rent, Electricity..."></div>
                    <div><label>Amount</label><input type="number" id="e-amt" placeholder="0"></div>
                </div>
                <button class="btn btn-danger" onclick="expense.add()">Add Expense</button>
            </div>
            <div id="expense-list" class="card"></div>
        </div>

        <div id="tab-settings" class="hidden owner-only">
            <div class="card">
                <h4 style="margin-top:0">Shop Logo</h4>
                <img id="logo-preview" src="" alt="No Logo" style="max-height:60px; margin-bottom:10px; display:block; border:1px dashed #ccc; padding:5px;">
                <input type="file" id="logo-upload" accept="image/*" onchange="settings.logo()">
            </div>
            
            <div class="card">
                <h4 style="margin-top:0">Data & Printing</h4>
                <label>Invoice Style</label>
                <select id="set-print" onchange="settings.printStyle()">
                    <option value="a4">A4 Standard (Laser/Inkjet)</option>
                    <option value="thermal">Thermal POS (58mm/80mm)</option>
                </select>
                <div class="grid-2" style="margin-top:10px">
                    <button class="btn btn-primary" onclick="settings.backup()">Backup Data</button>
                    <button class="btn btn-success" onclick="settings.exportExcel()">Export Excel</button>
                </div>
                <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="document.getElementById('restore-file').click()">Restore Data</button>
                <input type="file" id="restore-file" class="hidden" onchange="settings.restore()">
            </div>

            <div class="card" style="border-color:var(--danger); background:#fff5f5;">
                <h4 style="color:var(--danger); margin-top:0;">Danger Zone</h4>
                <p style="font-size:11px; margin-bottom:10px;">Use this to clear all data and start fresh.</p>
                <button class="btn btn-danger" onclick="app.reset()">Factory Reset App Data</button>
            </div>
        </div>

        <div class="nav-bar">
            <button class="nav-item active" onclick="ui.tab('dash')" id="nav-dash"><span>üè†</span>Home</button>
            <button class="nav-item" onclick="ui.tab('bill')" id="nav-bill"><span>üßæ</span>Bill</button>
            <button class="nav-item owner-only" onclick="ui.tab('stock')" id="nav-stock"><span>üì¶</span>Stock</button>
            <button class="nav-item owner-only" onclick="ui.tab('history')" id="nav-history"><span>üìú</span>History</button>
            <button class="nav-item owner-only" onclick="ui.tab('expense')" id="nav-expense"><span>üí∏</span>Exp</button>
            <button class="nav-item owner-only" onclick="ui.tab('settings')" id="nav-settings"><span>‚öôÔ∏è</span>Set</button>
        </div>
    </div>

    <div id="admin-panel" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#f8fafc; z-index:5000; overflow-y:auto; padding:15px;">
        <div class="flex-row space-between" style="background:white; padding:15px; border-radius:12px; margin-bottom:15px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
            <h2 style="margin:0; color:var(--primary);">Admin Master</h2>
            <button class="btn-sm btn-danger" onclick="location.reload()">Close</button>
        </div>
        <div id="admin-list"></div>
    </div>

    <div id="receipt-render-area"></div>
    <div id="print-area"></div>

<script>
    /* ==========================================================================
       CORE SYSTEM - VARIABLES & DATABASE (V19 FINAL)
       ========================================================================== */
    const DB_KEY = 'auraa_v19_'; // Clean Database Key
    let shop = null;
    let isStaff = false;
    let lastInvoice = null;

    // --- UTILS ---
    const el = (id) => document.getElementById(id);
    const val = (id) => el(id).value;
    const num = (id) => parseFloat(val(id)) || 0;
    const money = (n) => '‚Çπ' + (parseFloat(n) || 0).toFixed(2);

    /* ==========================================================================
       MODULE 1: APP CONTROLLER
       ========================================================================== */
    const app = {
        init: () => {
            const active = localStorage.getItem('auraa_active_user');
            const role = localStorage.getItem('auraa_user_role');
            if (active) {
                shop = JSON.parse(localStorage.getItem(DB_KEY + active));
                if (shop) {
                    if (role === 'staff') isStaff = true;
                    app.loadDash();
                }
            }
        },

        register: () => {
            const mob = val('r-mob').trim();
            if (!mob || mob.length < 10) return alert("Please enter valid 10-digit mobile");
            
            if (localStorage.getItem(DB_KEY + mob)) return alert("Error: Shop already registered!");
            
            const newShop = {
                mob: mob,
                name: val('r-name'),
                addr: val('r-addr'),
                pass: val('r-pass'),
                pin: val('r-pin'),
                expiry: Date.now() + (7 * 24 * 60 * 60 * 1000), // 7 Days Trial
                logo: '',
                printStyle: 'a4',
                stock: [],
                invoices: [],
                expenses: []
            };
            
            localStorage.setItem(DB_KEY + mob, JSON.stringify(newShop));
            alert("Registration Successful! Please Login.");
            ui.toggleAuth('login');
        },

        login: () => {
            const mob = val('l-mob').trim();
            const pass = val('l-pass');
            const data = localStorage.getItem(DB_KEY + mob);
            
            if (data) {
                const s = JSON.parse(data);
                if (s.pass === pass) {
                    shop = s;
                    localStorage.setItem('auraa_active_user', mob);
                    localStorage.setItem('auraa_user_role', 'owner');
                    isStaff = false;
                    app.loadDash();
                } else {
                    alert("Incorrect Password");
                }
            } else {
                alert("Shop not found. Register first.");
            }
        },

        save: () => {
            if (shop) localStorage.setItem(DB_KEY + shop.mob, JSON.stringify(shop));
        },

        logout: () => {
            localStorage.removeItem('auraa_active_user');
            localStorage.removeItem('auraa_user_role');
            location.reload();
        },

        reset: () => {
            if (confirm("DANGER: This will delete ALL shop data forever. Are you sure?")) {
                localStorage.clear();
                location.reload();
            }
        },
        
        loadDash: () => {
            el('auth-view').classList.add('hidden');
            el('app-view').classList.remove('hidden');
            el('shop-title').innerText = shop.name;
            ui.applyMode(); 

            // Expiry Logic
            if (Date.now() > shop.expiry) {
                el('sub-status').innerText = "‚óè EXPIRED";
                el('sub-status').style.color = "var(--danger)";
                el('btn-new-inv').classList.add('hidden'); 
                el('btn-save-bill').classList.add('btn-disabled');
                el('btn-save-bill').onclick = () => alert("Plan Expired. Contact Admin.");
            } else {
                el('sub-status').innerText = "‚óè Active Plan";
                el('sub-status').style.color = "var(--success)";
                el('btn-new-inv').classList.remove('hidden');
                el('btn-save-bill').classList.remove('btn-disabled');
                el('btn-save-bill').onclick = () => billing.save();
            }

            // Calculations
            const today = new Date().toLocaleDateString();
            let sale = 0, udhaar = 0, exp = 0, profit = 0;
            
            (shop.invoices || []).forEach(i => {
                if (i.date.includes(today)) sale += (i.final || 0);
                udhaar += (i.due || 0);
                (i.items || []).forEach(item => {
                    const cost = item.cost || (item.price * 0.8);
                    profit += (item.price - cost) * item.qty;
                });
            });

            (shop.expenses || []).forEach(e => exp += (e.amt || 0));

            el('d-sale').innerText = money(sale);
            el('d-udhaar').innerText = money(udhaar);
            el('d-exp').innerText = money(exp);
            el('d-profit').innerText = money(profit - exp);

            const low = (shop.stock || []).filter(i => i.qty < 5);
            el('low-stock-list').innerHTML = low.length ? low.map(i => `‚Ä¢ ${i.name} (${i.qty})`).join('<br>') : "‚úÖ Stock is Healthy";
            
            if (shop.logo) el('logo-preview').src = shop.logo;
            el('set-print').value = shop.printStyle || 'a4';
            
            billing.init();
            history.render();
        },

        toggleStaff: () => {
            if (isStaff) {
                const pin = prompt("Enter Owner PIN to Unlock:");
                if (pin === shop.pin) {
                    isStaff = false;
                    localStorage.setItem('auraa_user_role', 'owner');
                    alert("Owner Mode Active");
                    ui.applyMode();
                } else {
                    alert("Wrong PIN");
                }
            } else {
                if (confirm("Switch to Staff Mode? (Restricted Access)")) {
                    isStaff = true;
                    localStorage.setItem('auraa_user_role', 'staff');
                    ui.tab('bill');
                    ui.applyMode();
                }
            }
        }
    };

    /* ==========================================================================
       MODULE 2: BILLING & POS
       ========================================================================== */
    const billing = {
        init: () => {
            el('bill-rows-container').innerHTML = '';
            billing.addRow();
            el('btn-wa-share').classList.add('hidden'); 
        },
        
        checkCustomer: (input) => {
            const mob = input.value;
            if (mob.length > 5 && shop.invoices) {
                const last = [...shop.invoices].reverse().find(i => i.cMob === mob);
                if (last) {
                    el('b-cname').value = last.cName;
                    el('b-caddr').value = last.cAddr;
                }
            }
        },

        addRow: () => {
            const d = document.createElement('div');
            d.className = 'list-item grid-4';
            d.style.alignItems = 'end';
            d.innerHTML = `
                <div style="grid-column:span 4">
                    <input type="text" class="b-item" style="width:100%" placeholder="Search Item..." onchange="billing.fill(this)">
                </div>
                <div><label>MRP</label><input type="number" class="b-mrp" readonly></div>
                <div><label>Rate</label><input type="number" class="b-price" oninput="billing.calc()"></div>
                <div><label>Qty</label><input type="number" class="b-qty" value="1" oninput="billing.calc()"></div>
                <div><button class="btn-sm btn-danger" style="width:100%; margin-bottom:12px" onclick="this.parentElement.parentElement.remove();billing.calc()">X</button></div>
            `;
            el('bill-rows-container').appendChild(d);
        },

        fill: (inp) => {
            const item = (shop.stock || []).find(s => s.name.toLowerCase() === inp.value.toLowerCase());
            if (item) {
                const row = inp.parentElement.parentElement;
                row.querySelector('.b-mrp').value = item.mrp;
                row.querySelector('.b-price').value = item.sp;
                row.dataset.cost = item.cp; 
                billing.calc();
            }
        },

        calc: () => {
            let sub = 0;
            document.querySelectorAll('#bill-rows-container > div').forEach(r => {
                const q = parseFloat(r.querySelector('.b-qty').value) || 0;
                const p = parseFloat(r.querySelector('.b-price').value) || 0;
                sub += (q * p);
            });

            const dType = val('b-disc-type');
            const dVal = num('b-disc-val');
            const disc = dType === 'flat' ? dVal : (sub * dVal / 100);
            
            const tax = (sub - disc) * num('b-tax') / 100;
            const final = Math.round(sub - disc + tax);
            const paid = num('b-paid');
            
            el('b-total').innerText = money(final);
            el('b-due').innerText = money(Math.max(0, final - paid));

            return { sub, disc, tax, final, paid, due: Math.max(0, final - paid) };
        },

        save: () => {
            if (Date.now() > shop.expiry) return alert("Plan Expired!");
            if (val('b-cname') === '') return alert("Customer Name is Required");
            
            const c = billing.calc();
            if (c.sub === 0) return alert("Cart is Empty");
            
            const items = [];
            document.querySelectorAll('#bill-rows-container > div').forEach(r => {
                const name = r.querySelector('.b-item').value;
                const qty = parseFloat(r.querySelector('.b-qty').value) || 0;
                if (name && qty > 0) {
                    items.push({
                        name, qty,
                        mrp: parseFloat(r.querySelector('.b-mrp').value) || 0,
                        price: parseFloat(r.querySelector('.b-price').value) || 0,
                        cost: parseFloat(r.dataset.cost) || 0,
                        total: qty * (parseFloat(r.querySelector('.b-price').value) || 0)
                    });
                    
                    const s = (shop.stock || []).find(x => x.name === name);
                    if (s) s.qty -= qty;
                }
            });

            const inv = {
                id: Date.now(),
                date: new Date().toLocaleString(),
                cName: val('b-cname'),
                cMob: val('b-cmob'),
                cAddr: val('b-caddr'),
                items,
                ...c
            };

            shop.invoices.push(inv);
            app.save();
            printer.print(inv);
            
            lastInvoice = inv;
            el('btn-wa-share').classList.remove('hidden');
            
            el('bill-rows-container').innerHTML = ''; billing.addRow();
            el('b-cname').value = ''; el('b-cmob').value = ''; el('b-caddr').value = ''; el('b-paid').value = '';
            app.loadDash(); 
        },

        // --- IMAGE GENERATOR ---
        genImage: () => {
            if (!lastInvoice) return;
            const i = lastInvoice;
            const area = el('receipt-render-area');
            
            // Build Receipt HTML
            const rows = i.items.map(item => `<tr><td>${item.name}</td><td>${item.qty}</td><td>${item.price}</td><td>${item.total}</td></tr>`).join('');
            area.innerHTML = `
                <div class="r-header">
                    <h3>${shop.name}</h3>
                    <p>${shop.addr} | ${shop.mob}</p>
                    <p>${i.date}</p>
                    <p>To: ${i.cName}</p>
                </div>
                <table class="r-table">
                    <thead><tr><th>Item</th><th>Qty</th><th>Rate</th><th>Tot</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
                <div class="r-total">
                    Total: ${money(i.final)}<br>
                    Paid: ${money(i.paid)}<br>
                    Due: ${money(i.due)}
                </div>
                <center style="margin-top:10px">Thank You!</center>
            `;

            // Convert to Image using html2canvas
            html2canvas(area, { scale: 2 }).then(canvas => {
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], `Bill_${i.cName}.png`, { type: 'image/png' });
                    
                    // Try Web Share API (Mobile)
                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({ files: [file], title: 'Invoice', text: `Invoice for ${i.cName}` });
                        } catch (err) {
                            billing.fallbackDownload(canvas, i);
                        }
                    } else {
                        billing.fallbackDownload(canvas, i);
                    }
                });
            });
        },

        fallbackDownload: (canvas, i) => {
            const link = document.createElement('a');
            link.download = `Invoice_${i.cName}.png`;
            link.href = canvas.toDataURL();
            link.click();
            setTimeout(() => {
                const text = `*INVOICE: ${shop.name}*%0ATotal: ‚Çπ${i.final}%0ADue: ‚Çπ${i.due}`;
                window.open(`https://wa.me/91${i.cMob}?text=${text}`, '_blank');
            }, 1000);
        }
    };

    /* ==========================================================================
       MODULE 3: STOCK MANAGEMENT
       ========================================================================== */
    const stock = {
        add: () => {
            const name = val('s-name');
            if (!name) return alert("Item Name Required");
            
            const ex = (shop.stock || []).find(s => s.name === name);
            const item = {
                name,
                mrp: num('s-mrp'),
                sp: num('s-sp'),
                cp: num('s-cp'),
                qty: num('s-qty')
            };

            if (ex) {
                ex.qty += item.qty; ex.sp = item.sp; ex.mrp = item.mrp; ex.cp = item.cp;
            } else {
                shop.stock.push(item);
            }
            app.save();
            stock.render();
            alert("Stock Updated");
            el('s-name').value = ''; el('s-qty').value = '';
        },

        render: () => {
            const q = val('s-search').toLowerCase();
            el('stock-list').innerHTML = (shop.stock || []).filter(s => s.name.toLowerCase().includes(q)).map((s, i) => `
                <div class="list-item flex-row space-between">
                    <div>
                        <b style="font-size:16px">${s.name}</b><br>
                        <small style="color:var(--secondary)">MRP:${s.mrp} | SP:${s.sp} | CP:${s.cp}</small>
                    </div>
                    <div class="text-right">
                        <span style="background:${s.qty < 5 ? 'var(--danger)' : 'var(--success)'}; color:white; padding:2px 8px; border-radius:12px; font-size:12px">Qty: ${s.qty}</span><br>
                        <button class="btn-sm btn-danger" style="margin-top:5px" onclick="shop.stock.splice(${i},1);app.save();stock.render()">Delete</button>
                    </div>
                </div>`).join('');
        }
    };

    /* ==========================================================================
       MODULE 4: HISTORY & KHATA
       ========================================================================== */
    const history = {
        render: () => {
            const q = val('h-search').toLowerCase();
            el('history-list').innerHTML = [...(shop.invoices || [])].reverse().filter(i => i.cName.toLowerCase().includes(q)).map((i) => `
                <div class="card" style="border-left: 5px solid ${i.due > 0 ? 'var(--warning)' : 'var(--success)'}">
                    <div class="flex-row space-between">
                        <b>${i.cName}</b>
                        <b>${money(i.final)}</b>
                    </div>
                    <div class="flex-row space-between" style="font-size:11px; margin-top:5px; color:var(--secondary)">
                        <span>ID: #${i.id}</span>
                        <span style="color:${i.due > 0 ? 'var(--danger)' : 'var(--success)'}; font-weight:bold;">Due: ${money(i.due)}</span>
                    </div>
                    <div class="flex-row" style="margin-top:10px; justify-content:flex-end">
                        <button class="btn-sm btn-whatsapp" onclick="billing.genHistImage('${i.id}')">WA</button>
                        <button class="btn-sm btn-outline" onclick='printer.print(${JSON.stringify(i)})'>Print</button>
                        ${i.due > 0 ? `<button class="btn-sm btn-success" onclick="history.settle(${i.id})">Pay Due</button>` : ''}
                        <button class="btn-sm btn-danger" onclick="history.del(${i.id})">Del</button>
                    </div>
                </div>`).join('');
        },

        settle: (id) => {
            const amt = parseFloat(prompt("Enter Amount Received:"));
            if (!amt) return;
            const i = shop.invoices.find(x => x.id === id);
            if (amt > i.due) return alert("Error: Amount greater than due!");
            i.paid += amt;
            i.due -= amt;
            app.save();
            history.render();
            app.loadDash();
        },

        del: (id) => {
            if (isStaff) return alert("Access Denied: Owner Only");
            if (confirm("Delete this Invoice Permanently?")) {
                shop.invoices = shop.invoices.filter(x => x.id !== id);
                app.save();
                history.render();
                app.loadDash();
            }
        }
    };
    // Helper to share from history list
    billing.genHistImage = (id) => {
        lastInvoice = shop.invoices.find(x => x.id === id);
        if (lastInvoice) billing.genImage();
    };

    /* ==========================================================================
       MODULE 5: SETTINGS & EXCEL
       ========================================================================== */
    const expense = {
        add: () => {
            const d = val('e-desc'), a = num('e-amt');
            if (d && a) {
                shop.expenses.push({ desc: d, amt: a });
                app.save(); alert("Expense Added"); el('e-desc').value = ''; el('e-amt').value = ''; app.loadDash();
            }
        }
    };

    const settings = {
        logo: () => {
            const f = el('logo-upload').files[0];
            const r = new FileReader();
            r.onload = e => { shop.logo = e.target.result; el('logo-preview').src = shop.logo; app.save(); };
            if (f) r.readAsDataURL(f);
        },
        printStyle: () => { shop.printStyle = val('set-print'); app.save(); },
        backup: () => {
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(shop));
            a.download = `Backup_${shop.name}.json`;
            a.click();
        },
        restore: () => {
            const f = el('restore-file').files[0];
            const r = new FileReader();
            r.onload = e => { shop = JSON.parse(e.target.result); app.save(); location.reload(); };
            if (f) r.readAsText(f);
        },
        exportExcel: () => {
            if(!shop.invoices.length) return alert("No Data to Export");
            let csv = "Date,Invoice ID,Customer Name,Mobile,Total Amount,Paid,Due Balance\n";
            shop.invoices.forEach(i => {
                csv += `"${i.date}",${i.id},"${i.cName}",${i.cMob},${i.final},${i.paid},${i.due}\n`;
            });
            const link = document.createElement("a");
            link.href = encodeURI("data:text/csv;charset=utf-8," + csv);
            link.download = `Sales_Report_${shop.name}.csv`;
            link.click();
        }
    };

    /* ==========================================================================
       MODULE 6: PRINT ENGINE
       ========================================================================== */
    const printer = {
        print: (inv) => {
            const logo = shop.logo ? `<img src="${shop.logo}">` : '';
            const rows = inv.items.map(i => {
                const mrp = i.mrp || i.price;
                const save = (mrp - i.price) * i.qty;
                return `<tr>
                    <td>${i.name}</td>
                    <td class="col-num">${mrp}</td>
                    <td class="col-num">${i.price}</td>
                    <td class="col-num">${i.qty}</td>
                    <td class="col-num">${save > 0 ? money(save) : '-'}</td>
                    <td class="col-num">${money(i.total)}</td>
                </tr>`;
            }).join('');
            
            let html = '';
            if ((shop.printStyle || 'a4') === 'a4') {
                html = `<div class="print-a4">
                    <div class="header">${logo}<h1>${shop.name}</h1><p>${shop.addr} | Mob: ${shop.mob}</p></div>
                    <div class="meta"><div><b>To:</b> ${inv.cName}<br>${inv.cAddr || ''}<br>${inv.cMob || ''}</div><div class="col-num"><b>Inv #:</b> ${inv.id}<br><b>Date:</b> ${inv.date}</div></div>
                    <table><thead><tr><th>Item</th><th class="col-num">MRP</th><th class="col-num">Rate</th><th class="col-num">Qty</th><th class="col-num">Disc.</th><th class="col-num">Total</th></tr></thead><tbody>${rows}</tbody></table>
                    <div class="totals"><p>Subtotal: ${money(inv.sub)}</p><p>Tax: ${money(inv.tax)}</p><p>Discount: -${money(inv.disc)}</p><div class="grand-total">Total: ${money(inv.final)}</div><p>Paid: ${money(inv.paid)} | Due: ${money(inv.due)}</p></div>
                    <center style="margin-top:40px;font-size:12px">Thank You for Shopping!</center>
                </div>`;
            } else {
                html = `<div class="print-thermal">
                    <div class="header">${logo}<b>${shop.name}</b><br>${shop.mob}</div>
                    <div style="border-bottom:1px dashed #000;margin-bottom:5px">To: ${inv.cName}</div>
                    <table><thead><tr><th>Item</th><th class="col-num">Rt</th><th class="col-num">Q</th><th class="col-num">Tot</th></tr></thead><tbody>${inv.items.map(i => `<tr><td>${i.name}</td><td class="col-num">${i.price}</td><td class="col-num">${i.qty}</td><td class="col-num">${i.total}</td></tr>`).join('')}</tbody></table>
                    <div class="totals">Net: <b>${money(inv.final)}</b><br>Due: ${money(inv.due)}</div><center style="margin-top:10px">Thank You</center>
                </div>`;
            }
            el('print-area').innerHTML = html;
            setTimeout(() => window.print(), 500);
        }
    };

    /* ==========================================================================
       MODULE 7: UI & ADMIN
       ========================================================================== */
    const ui = {
        toggleAuth: (id) => {
            ['login-box', 'reg-box', 'admin-box'].forEach(e => el(e).classList.add('hidden'));
            el(id.includes('box') ? id : id + '-box').classList.remove('hidden');
        },
        tab: (id) => {
            if (isStaff && ['stock', 'history', 'expense', 'settings'].includes(id)) return alert("Access Denied: Staff Mode Active");
            ['dash', 'bill', 'stock', 'history', 'expense', 'settings'].forEach(t => {
                el('tab-' + t).classList.add('hidden');
                el('nav-' + t).classList.remove('active');
            });
            el('tab-' + id).classList.remove('hidden');
            el('nav-' + id).classList.add('active');
            if (id === 'stock') stock.render();
            if (id === 'history') history.render();
        },
        applyMode: () => {
            document.body.classList.toggle('staff-mode', isStaff);
            el('lock-btn').innerText = isStaff ? "üîì Unlock" : "üîí Staff";
            el('lock-btn').className = isStaff ? "btn-sm btn-success" : "btn-sm btn-warning";
        }
    };

    const admin = {
        login: () => {
            if (val('a-pass') === "kusum231205") {
                el('auth-view').classList.add('hidden');
                el('admin-panel').classList.remove('hidden');
                admin.render();
            } else alert("Wrong Password");
        },
        render: () => {
            el('admin-list').innerHTML = Object.keys(localStorage).filter(k => k.includes(DB_KEY)).map(k => {
                const s = JSON.parse(localStorage.getItem(k));
                const days = Math.ceil((s.expiry - Date.now()) / 86400000);
                return `<div class="card">
                    <div class="flex-row space-between"><b>${s.name}</b> <span>${s.mob}</span></div>
                    <div style="font-size:11px; margin:5px 0; color:var(--secondary)">Pass: <b>${s.pass}</b> | PIN: <b>${s.pin}</b></div>
                    <div class="flex-row space-between" style="background:#f8fafc; padding:5px; border-radius:5px">
                        <span style="color:${days > 0 ? 'green' : 'red'}">Valid: ${days} Days</span>
                    </div>
                    <div class="grid-4" style="margin-top:5px;">
                        <button class="btn-sm btn-primary" onclick="admin.ext('${k}',7)">+7D</button>
                        <button class="btn-sm btn-success" onclick="admin.ext('${k}',90)">+3M</button>
                        <button class="btn-sm btn-success" onclick="admin.ext('${k}',180)">+6M</button>
                        <button class="btn-sm btn-success" onclick="admin.ext('${k}',365)">+1Y</button>
                    </div>
                    <button class="btn-sm btn-danger" style="width:100%; margin-top:5px;" onclick="admin.ext('${k}',-1)">Expire Now (Stop)</button>
                </div>`;
            }).join('');
        },
        ext: (k, d) => {
            const s = JSON.parse(localStorage.getItem(k));
            if (d === -1) s.expiry = 0;
            else s.expiry = Math.max(Date.now(), s.expiry) + (d * 24 * 60 * 60 * 1000);
            localStorage.setItem(k, JSON.stringify(s));
            admin.render();
            alert("Validity Updated Successfully!");
        }
    };

    // START APP
    app.init();
</script>
</body>
</html>
